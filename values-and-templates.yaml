# Helm Chart for AI Trading Platform (Multi-Tenant SaaS)

# ============================================
# Chart.yaml
# ============================================
apiVersion: v2
name: ai-trading-platform
description: Multi-Tenant AI Trading Platform with Auto-Scaling
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - trading
  - ai
  - fintech
  - multi-tenant
maintainers:
  - name: Platform Team
    email: platform@yourcompany.com

# ============================================
# values.yaml - Production Configuration
# ============================================
# Global settings
global:
  environment: production
  domain: api.trading-platform.com
  timezone: UTC

# Replica counts (auto-scaling enabled)
replicaCount:
  gateway: 3
  strategyEngine: 2
  executionEngine: 2
  riskManager: 2
  aiModels: 1
  marketData: 2
  tenantManager: 2
  metering: 1

# Image configuration
image:
  repository: trading-platform
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod Security
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8000"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Service configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8000

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: api.trading-platform.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: trading-platform-tls
      hosts:
        - api.trading-platform.com

# Resource limits (per pod)
resources:
  gateway:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi
  
  strategyEngine:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi
  
  executionEngine:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 1000m
      memory: 1Gi
  
  aiModels:
    limits:
      cpu: 4000m
      memory: 8Gi
      nvidia.com/gpu: 1  # GPU for AI inference
    requests:
      cpu: 2000m
      memory: 4Gi
      nvidia.com/gpu: 1
  
  riskManager:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 20
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node affinity and tolerations
nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - trading-platform
          topologyKey: kubernetes.io/hostname

# Environment variables
env:
  # Database
  DATABASE_URL: "postgresql://user:pass@postgres:5432/trading_master"
  TIMESCALE_URL: "postgresql://user:pass@timescaledb:5432/market_data"
  
  # Cache
  REDIS_URL: "redis://redis:6379/0"
  
  # Message Queue
  KAFKA_BROKERS: "kafka:9092"
  
  # AI Models
  AI_MODEL_PATH: "/models"
  
  # Monitoring
  PROMETHEUS_URL: "http://prometheus:9090"
  SENTRY_DSN: ""
  
  # Feature Flags
  ENABLE_MULTI_TENANT: "true"
  ENABLE_METERING: "true"
  ENABLE_SYNC_AGENT: "true"

# ConfigMap data
configMap:
  risk_limits.yaml: |
    max_position_size_usd: 10000
    max_daily_loss_usd: 1000
    max_drawdown_pct: 0.10
    kill_switch_enabled: true

# Secrets (use external secret manager in production)
secrets:
  create: true
  data: {}
    # API_KEYS: base64_encoded_value
    # JWT_SECRET: base64_encoded_value

# PostgreSQL (master database)
postgresql:
  enabled: true
  auth:
    username: trading_user
    password: changeme
    database: trading_master
  primary:
    persistence:
      enabled: true
      size: 50Gi
      storageClass: "gp3"
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 1000m
        memory: 2Gi

# TimescaleDB (time-series data)
timescaledb:
  enabled: true
  image: timescale/timescaledb:latest-pg15
  persistence:
    enabled: true
    size: 100Gi
    storageClass: "gp3"
  resources:
    limits:
      cpu: 4000m
      memory: 8Gi
    requests:
      cpu: 2000m
      memory: 4Gi

# Redis (caching and pub/sub)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: changeme
  master:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

# Kafka (message queue)
kafka:
  enabled: true
  replicaCount: 3
  persistence:
    enabled: true
    size: 50Gi
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi

# Prometheus (monitoring)
prometheus:
  enabled: true
  server:
    retention: "15d"
    persistentVolume:
      enabled: true
      size: 50Gi

# Grafana (dashboards)
grafana:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
  adminPassword: changeme

# ============================================
# templates/deployment.yaml
# ============================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}-gateway
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
    component: gateway
spec:
  replicas: {{ .Values.replicaCount.gateway }}
  selector:
    matchLabels:
      {{- include "ai-trading-platform.selectorLabels" . | nindent 6 }}
      component: gateway
  template:
    metadata:
      annotations:
        {{- toYaml .Values.podAnnotations | nindent 8 }}
      labels:
        {{- include "ai-trading-platform.selectorLabels" . | nindent 8 }}
        component: gateway
    spec:
      serviceAccountName: {{ include "ai-trading-platform.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
      - name: gateway
        image: "{{ .Values.image.repository }}/gateway:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        env:
        {{- range $key, $value := .Values.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          {{- toYaml .Values.resources.gateway | nindent 10 }}
        volumeMounts:
        - name: config
          mountPath: /config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: {{ include "ai-trading-platform.fullname" . }}-config
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}
      affinity:
        {{- toYaml .Values.affinity | nindent 8 }}
      tolerations:
        {{- toYaml .Values.tolerations | nindent 8 }}

---
# Similar deployments for other services...
# (strategyEngine, executionEngine, riskManager, aiModels, etc.)

# ============================================
# templates/hpa.yaml - Horizontal Pod Autoscaler
# ============================================
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}-gateway
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "ai-trading-platform.fullname" . }}-gateway
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
  {{- if .Values.autoscaling.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}
  {{- end }}
  {{- if .Values.autoscaling.targetMemoryUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetMemoryUtilizationPercentage }}
  {{- end }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
{{- end }}

# ============================================
# templates/service.yaml
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}-gateway
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
    component: gateway
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "ai-trading-platform.selectorLabels" . | nindent 4 }}
    component: gateway

# ============================================
# templates/ingress.yaml
# ============================================
{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  ingressClassName: {{ .Values.ingress.className }}
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            pathType: {{ .pathType }}
            backend:
              service:
                name: {{ include "ai-trading-platform.fullname" $ }}-gateway
                port:
                  number: {{ $.Values.service.port }}
          {{- end }}
    {{- end }}
{{- end }}

# ============================================
# templates/configmap.yaml
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}-config
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
data:
  {{- toYaml .Values.configMap | nindent 2 }}

# ============================================
# templates/pvc.yaml - Persistent Volume Claims
# ============================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "ai-trading-platform.fullname" . }}-models
  labels:
    {{- include "ai-trading-platform.labels" . | nindent 4 }}
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "efs"  # AWS EFS for shared model storage
  resources:
    requests:
      storage: 100Gi

---
# ============================================
# DEPLOYMENT INSTRUCTIONS
# ============================================
# 
# 1. Add Helm repository:
#    helm repo add bitnami https://charts.bitnami.com/bitnami
#    helm repo update
# 
# 2. Install chart (development):
#    helm install ai-trading-platform . \
#      --namespace trading-dev \
#      --create-namespace \
#      -f values-dev.yaml
# 
# 3. Install chart (production):
#    helm install ai-trading-platform . \
#      --namespace trading-prod \
#      --create-namespace \
#      -f values-prod.yaml
# 
# 4. Upgrade deployment:
#    helm upgrade ai-trading-platform . \
#      --namespace trading-prod \
#      -f values-prod.yaml
# 
# 5. Rollback:
#    helm rollback ai-trading-platform \
#      --namespace trading-prod
# 
# 6. Uninstall:
#    helm uninstall ai-trading-platform \
#      --namespace trading-prod
# 
# 7. Check status:
#    kubectl get pods -n trading-prod
#    kubectl get hpa -n trading-prod
#    kubectl top pods -n trading-prod
# 
# ============================================
# SCALING COMMANDS
# ============================================
# 
# Manual scaling:
#    kubectl scale deployment/ai-trading-platform-gateway \
#      --replicas=10 -n trading-prod
# 
# Check autoscaling:
#    kubectl get hpa -n trading-prod -w
# 
# View metrics:
#    kubectl top nodes
#    kubectl top pods -n trading-prod
# 
# ============================================
# MONITORING
# ============================================
# 
# Port-forward Grafana:
#    kubectl port-forward svc/grafana 3000:80 -n trading-prod
#    Open: http://localhost:3000
# 
# Port-forward Prometheus:
#    kubectl port-forward svc/prometheus 9090:80 -n trading-prod
#    Open: http://localhost:9090
# 
# View logs:
#    kubectl logs -f deployment/ai-trading-platform-gateway -n trading-prod
# 
# ============================================
